---
- name: Generate a test ID
  ansible.builtin.set_fact:
    test_id: "{{ lookup('password', '/dev/null chars=ascii_letters length=16') }}"
  when: test_id is not defined

- name: Get existing service clusters
  ansible.builtin.set_fact:
    _sc_query: "{{ query('ansible.platform.gateway_api', 'service_clusters', **connection_info) }}"

- name: Fail if more than one service cluster or that cluster is not a gateway cluster
  ansible.builtin.fail:
    msg: "This test works with 3 service clusters: gateway, eda and hub. It appears you might already have one or more of those, failing"
  when:
    - _sc_query | length > 1
    - _sc_query | length == 1 and _sc_query[0].type != 'gateway'

- name: Run Test
  module_defaults:
    group/ansible.platform.gateway:
      gateway_hostname: "{{ gateway_hostname }}"
      gateway_username: "{{ gateway_username }}"
      gateway_password: "{{ gateway_password }}"
      gateway_validate_certs: "{{ gateway_validate_certs | bool }}"

  block:
    - name: Create Controller Service Type with check mode
      ansible.platform.service_type:
        name: "{{ test_id }}controller"
        ping_url: "/api/ping/"
        login_path: "/api/login/"
        logout_path: "/api/logout/"
        service_index_path: "/api/service-index/"
      check_mode: true

    - name: Search for the Controller Service Type and assert that it does not exist
      ansible.builtin.set_fact:
        item_that_should_not_exist: "{{ lookup('ansible.platform.gateway_api', 'service_clusters',
          query_params={'name': '{{ test_id }}controller'}, **connection_info) }}"

    - name: Assert that Route does not exist
      ansible.builtin.assert:
        that:
          - item_that_should_not_exist is not defined or item_that_should_not_exist | length == 0
        fail_msg: "Service Type '{{ test_id }}controller' exists in the system!"

    - name: Create Controller Service Type
      ansible.platform.service_type:
        name: "{{ test_id }}controller"
        ping_url: "/api/ping/"
        login_path: "/api/login/"
        logout_path: "/api/logout/"
        service_index_path: "/api/service-index/"
      register: controller_st

    - name: Create Controller Service Cluster
      ansible.platform.service_cluster:
        name: "{{ test_id }}-Automation-Controller"
        service_type: "{{ controller_st.id }}"
        health_check_interval_seconds: 1162
        dns_discovery_type: LOGICAL_DNS
        dns_lookup_family: V4_ONLY
      register: controller_sc

    - name: Assert that we created the controller service cluster
      ansible.builtin.assert:
        that:
          - controller_sc is changed

    - name: Recreate Controller Service Cluster
      ansible.platform.service_cluster:
        name: "{{ test_id }}-Automation-Controller"
        service_type: "{{ controller_st.id }}"
        health_check_interval_seconds: 1162
      register: recreate_controller_sc

    - name: Assert that we a recreate does not change the system
      ansible.builtin.assert:
        that:
          - recreate_controller_sc is not changed

    - name: Create Automation Hub Service Type
      ansible.platform.service_type:
        name: "{{ test_id }}hub"
        ping_url: "/api/ping/"
        login_path: "/api/login/"
        logout_path: "/api/logout/"
        service_index_path: "/api/service-index/"
      register: hub_st

    - name: Create Automation Hub Cluster
      ansible.platform.service_cluster:
        name: "{{ test_id }}-Automation-Hub"
        service_type: "{{ hub_st.id }}"
        health_check_interval_seconds: 1162
        upstream_hostname: hub.com
      register: hub_sc

    - name: Assert that we created the hub service cluster
      ansible.builtin.assert:
        that:
          - hub_sc is changed

    - name: Create EDA Service Type
      ansible.platform.service_type:
        name: "{{ test_id }}eda"
        ping_url: "/api/ping/"
        login_path: "/api/login/"
        logout_path: "/api/logout/"
        service_index_path: "/api/service-index/"
      register: eda_st

    - name: Create EDA Service Cluster
      ansible.platform.service_cluster:
        name: "{{ test_id }}-AAP-eda"
        service_type: "{{ eda_st.id }}"
        health_check_interval_seconds: 333
      register: eda_sc

    - name: Assert that we created the eda service cluster
      ansible.builtin.assert:
        that:
          - eda_sc is changed

    - name: Assert that exists works
      ansible.platform.service_cluster:
        name: "{{  controller_sc.name }}"
        state: exists
      register: exists_controller_sc

    - name: Assert that exists does not change the system
      ansible.builtin.assert:
        that:
          - exists_controller_sc is not changed

    - name: Assert exists works with parameters
      ansible.platform.service_cluster:
        name: "{{ hub_sc.name }}"
        service_type: "{{ hub_st.id }}"
        upstream_hostname: hub.com
        state: exists
      register: exists_hub

    - name: Assert that exists does not change the system
      ansible.builtin.assert:
        that:
          - exists_hub is not changed

    - name: Rename a service cluster
      ansible.platform.service_cluster:
        name: "{{ eda_sc.id }}" # AAP gateway
        new_name: "Event Driven Automation"
      register: renamed_eda_sc

    - name: Assert that we can rename a service cluster
      ansible.builtin.assert:
        that:
          - renamed_eda_sc is changed
          - renamed_eda_sc.id == eda_sc.id

    - name: Change a health check interval
      ansible.platform.service_cluster:
        name: "{{ eda_sc.id }}"
        health_check_interval_seconds: 1162
      register: changed_eda_sc

    - name: Assert that we can change a service cluster
      ansible.builtin.assert:
        that:
          - changed_eda_sc is changed
          - changed_eda_sc.id == eda_sc.id

    - name: Query the server for service clusters  with specific health check interval
      ansible.builtin.set_fact:
        _sc_query: "{{ query('ansible.platform.gateway_api', 'service_clusters/?health_check_interval_seconds=1162', **connection_info) }}"

    - name: Ensure we have 3 service clusters with health_check_interval_seconds=1162
      ansible.builtin.assert:
        that:
          - _sc_query | length == 3

    - name: Delete a non-existent service cluster
      ansible.platform.service_cluster:
        name: "{{ test_id }}-DoesNotExist"
        state: absent
      register: delete_dne

    - name: Assert that the deletion of a non-existent does not change the system
      ansible.builtin.assert:
        that:
          - delete_dne is not changed

    - name: Delete a real service cluster
      ansible.platform.service_cluster:
        name: "{{ controller_sc.id }}"
        state: absent
      register: delete_controller_sc

    - name: Assert that deletion of a real service cluster changes the system
      ansible.builtin.assert:
        that:
          - delete_controller_sc is changed

    - name: Change a service type
      ansible.platform.service_cluster:
        name: "{{ eda_sc.id }}"
        service_type: "{{ controller_st.id }}"
      register: change_eda_sc

    - name: Assert that we can change a cluster type
      ansible.builtin.assert:
        that:
          - change_eda_sc is changed
          - change_eda_sc.id == eda_sc.id

    - name: Change auth_type for a service
      ansible.platform.service_cluster:
        name: "{{ eda_sc.id }}"
        auth_type: "TOKEN"
      register: change_eda_auth_type

    - name: Assert that auth_type is changed
      ansible.builtin.assert:
        that:
          - change_eda_auth_type is changed

  always:
    # Always Cleanup
    - name: Delete Service Clusters
      ansible.platform.service_cluster:
        name: "{{ vars[item].id }}"
        state: absent
      loop:
        - "controller_sc"
        - "hub_sc"
        - "eda_sc"
      when: "item in vars and 'id' in vars[item]"

    - name: Delete Service Types
      ansible.platform.service_type:
        name: "{{ item.name }}"
        state: absent
      loop: "{{ gateway_service_types }}"
      vars:
        gateway_service_types:
          - name: "{{ test_id }}controller"
          - name: "{{ test_id }}hub"
          - name: "{{ test_id }}eda"
...
